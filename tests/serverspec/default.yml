---
- hosts: localhost
  roles:
    - ansible-role-unbound
  vars:
    debian_flags:
      DAEMON_OPTS: "-v -c {{ unbound_conf_file }}"
    freebsd_flags:
      unbound_flags: "-v -c {{ unbound_conf_file }}"
    redhat_flags:
      UNBOUND_OPTIONS: "-v -c {{ unbound_conf_file }}"
    openbsd_flags:
      flags: "-v -c {{ unbound_conf_file }}"

    unbound_flags: "{% if ansible_os_family == 'Debian' %}{{ debian_flags }}{% elif ansible_os_family == 'FreeBSD' %}{{ freebsd_flags }}{% elif ansible_os_family == 'RedHat' %}{{ redhat_flags }}{% elif ansible_os_family == 'OpenBSD' %}{{ openbsd_flags }}{% endif %}"

    unbound_config_chroot: ""
    unbound_config: |
      server:
        chroot: ""
        directory: "{{ unbound_directory }}"
        outgoing-interface: {{ ansible_default_ipv4.address }}
        do-not-query-localhost: yes
        do-ip4: yes
        do-ip6: no
        hide-identity: yes
        hide-version: yes
        use-syslog: yes
        local-zone: 10.in-addr.arpa nodefault
        local-zone: 168.192.in-addr.arpa nodefault
        access-control: 0.0.0.0/0 refuse
        access-control: 127.0.0.0/8 allow
        access-control: 10.100.1.0/24 allow
        private-address: 10.0.0.0/8
        private-address: 172.16.0.0/12
        private-address: 192.168.0.0/16
        private-address: 192.254.0.0/16
        private-address: fc00::/7
        private-address: fd00::/8
        private-address: fe80::/10
        private-domain: "example.com"
        interface: {{ ansible_default_ipv4.address }}
      forward-zone:
        name: "example.com"
        forward-addr: "8.8.8.8"
        forward-addr: "8.8.4.4"
      forward-zone:
        name: "example.org"
        forward-addr: "8.8.8.8"
      stub-zone:
        name: "example.net"
        stub-addr: "8.8.8.8"
        stub-addr: "8.8.4.4"
      stub-zone:
        name: "foo.example"
        stub-addr: "8.8.8.8"
      remote-control:
        control-enable: yes
      {% if unbound_version | version_compare('1.5.2', '>=') %}
        control-use-cert: no
      {% endif %}
      {% if unbound_version | version_compare('1.5.3', '<=') %}
        control-interface: 127.0.0.1
      {% else %}
        control-interface: /var/run/unbound.sock
      {% endif %}
        server-key-file: {{ unbound_conf_dir }}/unbound_server.key
        server-cert-file: {{ unbound_conf_dir }}/unbound_server.pem
        control-key-file: {{ unbound_conf_dir }}/unbound_control.key
        control-cert-file: {{ unbound_conf_dir }}/unbound_control.pem
